{% extends "admin/admin_dash.html" %}

{% block content %}
<h2 class="text-center">Offer Management <i class="fa fa-tag"></i></h2>

<!-- Tabs for Offer Types -->
<div class="tab-container">
    <button class="tab-button active" onclick="showTab('regular-offers')">Product & Category Offers</button>
    <button class="tab-button" onclick="showTab('referral-offers')">Referral Offers</button>
</div>

<div class="button-container">
    <input type="text" id="search" placeholder="Search offers..." onkeyup="filterOffers()" class="search-box">
    <a href="{% url 'create_offer' %}"><button class="add-button">‚ûï Add New Offer</button></a>
</div>

<!-- Regular Offers Table -->
<div id="regular-offers" class="offer-table active">
    <table class="styled-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Type</th>
                <th>Discount</th>
                <th>Valid</th>
                <th>Product</th>
                <th>Category</th>
                <th>Min Purchase</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="offer-list">
            <tr><td colspan="10" class="loading">Loading...</td></tr>
        </tbody>
    </table>
</div>

<!-- Referral Offers Table -->
<div id="referral-offers" class="offer-table">
    <div class="referral-tabs">
        <button class="referral-tab-button active" onclick="showReferralTab('referral-config')">Referral Offer Config</button>
        <button class="referral-tab-button" onclick="showReferralTab('referral-claims')">Referral Claims</button>
    </div>

    <div id="referral-config" class="referral-section active">
        <table class="styled-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Reward Amount</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="referral-offer-list">
                <tr><td colspan="3" class="loading">Loading...</td></tr>
            </tbody>
        </table>
    </div>

    <div id="referral-claims" class="referral-section">
        <table class="styled-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Referrer</th>
                    <th>Referred User</th>
                    <th>Reward Amount</th>
                    <th>Claimed</th>
                </tr>
            </thead>
            <tbody id="referral-claim-list">
                <tr><td colspan="5" class="loading">Loading...</td></tr>
            </tbody>
        </table>
    </div>
</div>
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<script>
document.addEventListener("DOMContentLoaded", function () {
    fetchOffers();
    fetchReferralOffers();
    fetchReferralClaims();

    function fetchOffers() {
        fetch("/api/offers/")
            .then(res => res.json())
            .then(data => {
                const tableBody = document.getElementById("offer-list");
                tableBody.innerHTML = data.length ? "" : `<tr><td colspan="10" class="no-data">No offers found.</td></tr>`;
                data.forEach(offer => {
                    const row = `
                        <tr>
                            <td>${offer.id}</td>
                            <td>${offer.type}</td>
                            <td>${offer.discount}%</td>
                            <td>${offer.valid ? "‚úîÔ∏è" : "‚ùå"}</td>
                            <td>${offer.product || "-"}</td>
                            <td>${offer.category || "-"}</td>
                            <td>${offer.min_purchase}</td>
                            <td>${offer.start_date}</td>
                            <td>${offer.end_date}</td>
                            <td>
                                <a href="/offers/${offer.id}/edit/">
                                    <button class="edit-offer">‚úèÔ∏è Edit</button>
                                </a>
                                <button class="delete-offer" data-id="${offer.id}">üóëÔ∏è Delete</button>
                            </td>
                        </tr>`;
                    tableBody.innerHTML += row;
                });
            })
            .catch(() => {
                document.getElementById("offer-list").innerHTML = `<tr><td colspan="10" class="error">Failed to load offers.</td></tr>`;
            });
    }

    function fetchReferralOffers() {
        fetch("/api/referral-offers/")
            .then(res => res.json())
            .then(data => {
                const tableBody = document.getElementById("referral-offer-list");
                tableBody.innerHTML = data.length ? "" : `<tr><td colspan="3" class="no-data">No referral offers configured.</td></tr>`;
                data.forEach(offer => {
                    const row = `
                        <tr>
                            <td>${offer.id}</td>
                            <td>‚Çπ${offer.reward_amount}</td>
                            <td>
                                <a href="/offers/${offer.offer_id}/edit/">
                                    <button class="edit-offer">‚úèÔ∏è Edit</button>
                                </a>
                                <button class="delete-offer" data-id="${offer.id}" data-type="referral">üóëÔ∏è Delete</button>
                            </td>
                        </tr>`;
                    tableBody.innerHTML += row;
                });
            })
            .catch(() => {
                document.getElementById("referral-offer-list").innerHTML = `<tr><td colspan="3" class="error">Failed to load referral offers.</td></tr>`;
            });
    }

    function fetchReferralClaims() {
        fetch("/api/referral-claims/")
            .then(res => res.json())
            .then(data => {
                const tableBody = document.getElementById("referral-claim-list");
                tableBody.innerHTML = data.length ? "" : `<tr><td colspan="5" class="no-data">No referral claims found.</td></tr>`;
                data.forEach(claim => {
                    const row = `
                        <tr>
                            <td>${claim.id}</td>
                            <td>${claim.referrer.username}</td>
                            <td>${claim.referred_user.username}</td>
                            <td>‚Çπ${claim.reward_amount}</td>
                            <td>${claim.reward_claimed ? "‚úîÔ∏è" : "‚ùå"}</td>
                        </tr>`;
                    tableBody.innerHTML += row;
                });
            })
            .catch(() => {
                document.getElementById("referral-claim-list").innerHTML = `<tr><td colspan="5" class="error">Failed to load referral claims.</td></tr>`;
            });
    }

    document.addEventListener("click", function (e) {
        if (e.target.classList.contains("delete-offer")) {
            const offerId = e.target.getAttribute("data-id");
            const isReferral = e.target.getAttribute("data-type") === "referral";
            const url = isReferral ? `/api/referral-offers/${offerId}/delete/` : `/api/offers/${offerId}/delete/`;

            if (confirm("Are you sure you want to delete this offer?")) {
                fetch(url, {
                    method: "POST",  
                    headers: {
                        "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ action: "delete" }) 
                })
                .then(res => res.json())
                .then(data => {
                    alert(data.message || "Deleted.");
                    fetchOffers();
                    fetchReferralOffers();
                    fetchReferralClaims();
                })
                .catch(err => {
                    alert("Failed to delete. Try again.");
                    console.error("Delete error:", err);
                });
            }
        }
    });


    window.showTab = function (tabId) {
        document.querySelectorAll(".offer-table").forEach(tab => tab.classList.remove("active"));
        document.getElementById(tabId).classList.add("active");
        document.querySelectorAll(".tab-button").forEach(btn => btn.classList.remove("active"));
        document.querySelector(`[onclick="showTab('${tabId}')"]`).classList.add("active");
    };

    window.showReferralTab = function (tabId) {
        document.querySelectorAll(".referral-section").forEach(tab => tab.classList.remove("active"));
        document.getElementById(tabId).classList.add("active");
        document.querySelectorAll(".referral-tab-button").forEach(btn => btn.classList.remove("active"));
        document.querySelector(`[onclick="showReferralTab('${tabId}')"]`).classList.add("active");
    };
});
</script>

<style>
.tab-container, .referral-tabs {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 15px;
}
.tab-button, .referral-tab-button {
    padding: 10px 15px;
    border: none;
    background-color: #ddd;
    cursor: pointer;
    font-size: 14px;
    border-radius: 5px;
}
.tab-button.active, .referral-tab-button.active {
    background-color: #28a745;
    color: white;
}
.offer-table, .referral-section {
    display: none;
}
.offer-table.active, .referral-section.active {
    display: block;
}
.styled-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}
.styled-table th, .styled-table td {
    padding: 10px;
    text-align: center;
    border: 1px solid #ddd;
}
.styled-table th {
    background-color: #71771c;
    color: white;
}
.search-box {
    width: 100%;
    padding: 8px;
    margin-bottom: 10px;
    border: 1px solid #ccc;
}
.button-container {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
}
.loading, .no-data, .error {
    text-align: center;
    font-style: italic;
    color: #888;
}
.error { color: red; }
</style>
{% endblock %}
